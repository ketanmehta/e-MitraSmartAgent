/*!
 * Extensible 1.0.2
 * Copyright(c) 2010-2012 Extensible, LLC
 * licensing@ext.ensible.com
 * http://ext.ensible.com
 */
Ext.ensible.cal.DayViewDragZone=Ext.extend(Ext.ensible.cal.DragZone,{ddGroup:"DayViewDD",resizeSelector:".ext-evt-rsz",getDragData:function(c){var a=c.getTarget(this.resizeSelector,2,true);if(a){var b=a.parent(this.eventSelector),d=this.view.getEventRecordFromEl(b);if(!d){return}return{type:"eventresize",xy:c.xy,ddel:b.dom,eventStart:d.data[Ext.ensible.cal.EventMappings.StartDate.name],eventEnd:d.data[Ext.ensible.cal.EventMappings.EndDate.name],proxy:this.proxy}}var a=c.getTarget(this.eventSelector,3);if(a){var d=this.view.getEventRecordFromEl(a);if(!d){return}return{type:"eventdrag",xy:c.xy,ddel:a,eventStart:d.data[Ext.ensible.cal.EventMappings.StartDate.name],eventEnd:d.data[Ext.ensible.cal.EventMappings.EndDate.name],proxy:this.proxy}}a=this.view.getDayAt(c.xy[0],c.xy[1]);if(a.el){return{type:"caldrag",dayInfo:a,proxy:this.proxy}}return null}});Ext.ensible.cal.DayViewDropZone=Ext.extend(Ext.ensible.cal.DropZone,{ddGroup:"DayViewDD",dateRangeFormat:"{0}-{1}",dateFormat:"n/j",onNodeOver:function(c,m,k,h){var b,o=this.createText,g=Ext.ensible.Date.use24HourTime?"G:i":"g:ia";if(h.type=="caldrag"){if(!this.dragStartMarker){this.dragStartMarker=c.el.parent().createChild({style:"position:absolute;"});this.dragStartMarker.setBox(h.dayInfo.timeBox);this.dragCreateDt=h.dayInfo.date}var j,i=this.dragStartMarker.getBox();i.height=Math.ceil(Math.abs(k.xy[1]-i.y)/c.timeBox.height)*c.timeBox.height;if(k.xy[1]<i.y){i.height+=c.timeBox.height;i.y=i.y-i.height+c.timeBox.height;j=this.dragCreateDt.add(Date.MINUTE,this.ddIncrement)}else{c.date=c.date.add(Date.MINUTE,this.ddIncrement)}this.shim(this.dragCreateDt,i);var l=Ext.ensible.Date.diff(this.dragCreateDt,c.date),r=this.dragCreateDt.add(Date.MILLI,l);this.dragStartDate=Ext.ensible.Date.min(this.dragCreateDt,r);this.dragEndDate=j||Ext.ensible.Date.max(this.dragCreateDt,r);b=String.format(this.dateRangeFormat,this.dragStartDate.format(g),this.dragEndDate.format(g))}else{var q=Ext.get(h.ddel),p=q.parent().parent(),i=q.getBox();i.width=p.getWidth();if(h.type=="eventdrag"){if(this.dragOffset===undefined){var d=this.view.getDayAt(h.xy[0],h.xy[1]).timeBox;this.dragOffset=d.y-i.y}else{i.y=c.timeBox.y}b=c.date.format(this.dateFormat+" "+g);i.x=c.el.getLeft();this.shim(c.date,i);o=this.moveText}if(h.type=="eventresize"){if(!this.resizeDt){this.resizeDt=c.date}i.x=p.getLeft();i.height=Math.ceil(Math.abs(k.xy[1]-i.y)/c.timeBox.height)*c.timeBox.height;if(k.xy[1]<i.y){i.y-=i.height}else{c.date=c.date.add(Date.MINUTE,this.ddIncrement)}this.shim(this.resizeDt,i);var l=Ext.ensible.Date.diff(this.resizeDt,c.date),r=this.resizeDt.add(Date.MILLI,l),a=Ext.ensible.Date.min(h.eventStart,r),f=Ext.ensible.Date.max(h.eventStart,r);h.resizeDates={StartDate:a,EndDate:f};b=String.format(this.dateRangeFormat,a.format(g),f.format(g));o=this.resizeText}}h.proxy.updateMsg(String.format(o,b));return this.dropAllowed},shim:function(b,a){Ext.each(this.shims,function(d){if(d){d.isActive=false;d.hide()}});var c=this.shims[0];if(!c){c=this.createShim();this.shims[0]=c}c.isActive=true;c.show();c.setBox(a)},onNodeDrop:function(f,a,c,b){if(f&&b){if(b.type=="eventdrag"){var d=this.view.getEventRecordFromEl(b.ddel);this.view.onEventDrop(d,f.date);this.onCalendarDragComplete();delete this.dragOffset;return true}if(b.type=="eventresize"){var d=this.view.getEventRecordFromEl(b.ddel);this.view.onEventResize(d,b.resizeDates);this.onCalendarDragComplete();delete this.resizeDt;return true}if(b.type=="caldrag"){Ext.destroy(this.dragStartMarker);delete this.dragStartMarker;delete this.dragCreateDt;this.view.onCalendarEndDrag(this.dragStartDate,this.dragEndDate,this.onCalendarDragComplete.createDelegate(this));return true}}this.onCalendarDragComplete();return false}});