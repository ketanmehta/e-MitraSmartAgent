/*!
 * Extensible 1.0.2
 * Copyright(c) 2010-2012 Extensible, LLC
 * licensing@ext.ensible.com
 * http://ext.ensible.com
 */
Ext.ensible.cal.DragZone=Ext.extend(Ext.dd.DragZone,{ddGroup:"CalendarDD",eventSelector:".ext-cal-evt",constructor:function(b,a){if(!Ext.ensible.cal._statusProxyInstance){Ext.ensible.cal._statusProxyInstance=new Ext.ensible.cal.StatusProxy()}this.proxy=Ext.ensible.cal._statusProxyInstance;Ext.ensible.cal.DragZone.superclass.constructor.call(this,b,a)},getDragData:function(b){var a=b.getTarget(this.eventSelector,3);if(a){var c=this.view.getEventRecordFromEl(a);if(!c){return}return{type:"eventdrag",ddel:a,eventStart:c.data[Ext.ensible.cal.EventMappings.StartDate.name],eventEnd:c.data[Ext.ensible.cal.EventMappings.EndDate.name],proxy:this.proxy}}a=this.view.getDayAt(b.xy[0],b.xy[1]);if(a.el){return{type:"caldrag",start:a.date,proxy:this.proxy}}return null},onInitDrag:function(a,d){if(this.dragData.ddel){var b=this.dragData.ddel.cloneNode(true),c=Ext.fly(b).child("dl");Ext.fly(b).setWidth("auto");if(c){c.setHeight("auto")}this.proxy.update(b);this.onStartDrag(a,d)}else{if(this.dragData.start){this.onStartDrag(a,d)}}this.view.onInitDrag();return true},afterRepair:function(){if(Ext.enableFx&&this.dragData.ddel){Ext.Element.fly(this.dragData.ddel).highlight(this.hlColor||"c3daf9")}this.dragging=false},getRepairXY:function(a){if(this.dragData.ddel){return Ext.Element.fly(this.dragData.ddel).getXY()}},afterInvalidDrop:function(a,b){Ext.select(".ext-dd-shim").hide()},destroy:function(){Ext.ensible.cal.DragZone.superclass.destroy.call(this);delete Ext.ensible.cal._statusProxyInstance}});Ext.ensible.cal.DropZone=Ext.extend(Ext.dd.DropZone,{ddGroup:"CalendarDD",eventSelector:".ext-cal-evt",dateRangeFormat:"{0}-{1}",dateFormat:"n/j",shims:[],getTargetFromEvent:function(b){var a=this.dragOffset||0,f=b.getPageY()-a,c=this.view.getDayAt(b.getPageX(),f);return c.el?c:null},onNodeOver:function(d,j,i,g){var a=Ext.ensible.Date,b=g.type=="eventdrag"?d.date:a.min(g.start,d.date),f=g.type=="eventdrag"?d.date.add(Date.DAY,a.diffDays(g.eventStart,g.eventEnd)):a.max(g.start,d.date);if(!this.dragStartDate||!this.dragEndDate||(a.diffDays(b,this.dragStartDate)!=0)||(a.diffDays(f,this.dragEndDate)!=0)){this.dragStartDate=b;this.dragEndDate=f.clearTime().add(Date.DAY,1).add(Date.MINUTE,-30);this.shim(b,f);var h=b.format(this.dateFormat);if(a.diffDays(b,f)>0){f=f.format(this.dateFormat);h=String.format(this.dateRangeFormat,h,f)}var c=String.format(g.type=="eventdrag"?this.moveText:this.createText,h);g.proxy.updateMsg(c)}return this.dropAllowed},shim:function(a,e){this.currWeek=-1;var b=a.clone(),f=0,d,g,c=Ext.ensible.Date.diffDays(b,e)+1;Ext.each(this.shims,function(i){if(i){i.isActive=false}});while(f++<c){var h=this.view.getDayEl(b);if(h){var j=this.view.getWeekIndex(b),d=this.shims[j];if(!d){d=this.createShim();this.shims[j]=d}if(j!=this.currWeek){d.boxInfo=h.getBox();this.currWeek=j}else{g=h.getBox();d.boxInfo.right=g.right;d.boxInfo.width=g.right-d.boxInfo.x}d.isActive=true}b=b.add(Date.DAY,1)}Ext.each(this.shims,function(i){if(i){if(i.isActive){i.show();i.setBox(i.boxInfo)}else{if(i.isVisible()){i.hide()}}}})},createShim:function(){var a=this.view.ownerCalendarPanel?this.view.ownerCalendarPanel:this.view;if(!this.shimCt){this.shimCt=Ext.get("ext-dd-shim-ct-"+a.id);if(!this.shimCt){this.shimCt=document.createElement("div");this.shimCt.id="ext-dd-shim-ct-"+a.id;a.getEl().parent().appendChild(this.shimCt)}}var b=document.createElement("div");b.className="ext-dd-shim";this.shimCt.appendChild(b);return new Ext.Layer({shadow:false,useDisplay:true,constrain:false},b)},clearShims:function(){Ext.each(this.shims,function(a){if(a){a.hide()}})},onContainerOver:function(a,c,b){return this.dropAllowed},onCalendarDragComplete:function(){delete this.dragStartDate;delete this.dragEndDate;this.clearShims()},onNodeDrop:function(g,a,d,c){if(g&&c){if(c.type=="eventdrag"){var f=this.view.getEventRecordFromEl(c.ddel),b=Ext.ensible.Date.copyTime(f.data[Ext.ensible.cal.EventMappings.StartDate.name],g.date);this.view.onEventDrop(f,b);this.onCalendarDragComplete();return true}if(c.type=="caldrag"){this.view.onCalendarEndDrag(this.dragStartDate,this.dragEndDate,this.onCalendarDragComplete.createDelegate(this));return true}}this.onCalendarDragComplete();return false},onContainerDrop:function(a,c,b){this.onCalendarDragComplete();return false},destroy:function(){Ext.each(this.shims,function(a){if(a){Ext.destroy(a)}});Ext.removeNode(this.shimCt);delete this.shimCt;this.shims.length=0}});