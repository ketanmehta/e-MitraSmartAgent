/*!
 * Extensible 1.0.2
 * Copyright(c) 2010-2012 Extensible, LLC
 * licensing@ext.ensible.com
 * http://ext.ensible.com
 */
Ext.ensible.cal.EventEditWindow=Ext.extend(Ext.Window,{titleTextAdd:"Add Event",titleTextEdit:"Edit Event",width:600,border:true,closeAction:"hide",modal:false,resizable:false,buttonAlign:"left",labelWidth:65,detailsLinkText:"Edit Details...",savingMessage:"Saving changes...",deletingMessage:"Deleting event...",saveButtonText:"Save",deleteButtonText:"Delete",cancelButtonText:"Cancel",titleLabelText:"Title",datesLabelText:"When",calendarLabelText:"Calendar",editDetailsLinkClass:"edit-dtl-link",bodyStyle:"padding:5px 10px;",enableEditDetails:true,initComponent:function(){this.addEvents({eventadd:true,eventupdate:true,eventdelete:true,eventcancel:true,editdetails:true});this.fbar=["->",{text:this.saveButtonText,disabled:false,handler:this.onSave,scope:this},{id:this.id+"-delete-btn",text:this.deleteButtonText,disabled:false,handler:this.onDelete,scope:this,hideMode:"offsets"},{text:this.cancelButtonText,disabled:false,handler:this.onCancel,scope:this}];if(this.enableEditDetails!==false){this.fbar.unshift({xtype:"tbtext",text:'<a href="#" class="'+this.editDetailsLinkClass+'">'+this.detailsLinkText+"</a>"})}Ext.ensible.cal.EventEditWindow.superclass.initComponent.call(this)},onRender:function(c,a){this.deleteBtn=Ext.getCmp(this.id+"-delete-btn");this.titleField=new Ext.form.TextField({name:Ext.ensible.cal.EventMappings.Title.name,fieldLabel:this.titleLabelText,anchor:"100%"});this.dateRangeField=new Ext.ensible.cal.DateRangeField({anchor:"95%",fieldLabel:this.datesLabelText});var b=[this.titleField,this.dateRangeField];if(this.calendarStore){this.calendarField=new Ext.ensible.cal.CalendarCombo({name:Ext.ensible.cal.EventMappings.CalendarId.name,anchor:"100%",fieldLabel:this.calendarLabelText,store:this.calendarStore});b.push(this.calendarField)}this.formPanel=new Ext.FormPanel({labelWidth:this.labelWidth,frame:false,bodyBorder:false,border:false,items:b});this.add(this.formPanel);Ext.ensible.cal.EventEditWindow.superclass.onRender.call(this,c,a)},afterRender:function(){Ext.ensible.cal.EventEditWindow.superclass.afterRender.call(this);this.el.addClass("ext-cal-event-win");this.el.select("."+this.editDetailsLinkClass).on("click",this.onEditDetailsClick,this)},onEditDetailsClick:function(a){a.stopEvent();this.updateRecord(true);this.fireEvent("editdetails",this,this.activeRecord,this.animateTarget)},show:function(g,e){var c=(Ext.isIE8&&Ext.isStrict)?null:e,i=Ext.ensible.cal.EventMappings;Ext.ensible.cal.EventEditWindow.superclass.show.call(this,c,function(){this.titleField.focus(false,100)});this.deleteBtn[g.data&&g.data[i.EventId.name]?"show":"hide"]();var d,b=this.formPanel.form;if(g.data){d=g;if(d.phantom){this.setTitle(this.titleTextAdd)}else{this.setTitle(this.titleTextEdit)}b.loadRecord(d)}else{this.setTitle(this.titleTextAdd);var h=g[i.StartDate.name],a=g[i.EndDate.name]||h.add("h",1);d=new Ext.ensible.cal.EventRecord();d.data[i.StartDate.name]=h;d.data[i.EndDate.name]=a;d.data[i.IsAllDay.name]=!!g[i.IsAllDay.name]||h.getDate()!=a.clone().add(Date.MILLI,1).getDate();b.reset();b.loadRecord(d)}if(this.calendarStore){this.calendarField.setValue(d.data[i.CalendarId.name])}this.dateRangeField.setValue(d.data);this.activeRecord=d;this.el.setStyle("z-index",12000);return this},roundTime:function(b,c){c=c||15;var a=parseInt(b.getMinutes());return b.add("mi",c-(a%c))},onCancel:function(){this.cleanup(true);this.fireEvent("eventcancel",this,this.animateTarget)},cleanup:function(a){if(this.activeRecord){this.activeRecord.reject()}delete this.activeRecord;if(a===true){this.hide()}},updateRecord:function(d){var e=this.dateRangeField.getValue(),g=Ext.ensible.cal.EventMappings,f=this.activeRecord,c=this.formPanel.form,a=f.fields,b=false;f.beginEdit();a.each(function(i){var j=c.findField(i.name);if(j){var h=j.getValue();if(h.getGroupValue){h=h.getGroupValue()}else{if(j.eachItem){h=[];j.eachItem(function(k){h.push(k.getValue())})}}f.set(i.name,h)}},this);f.set(g.StartDate.name,e[0]);f.set(g.EndDate.name,e[1]);f.set(g.IsAllDay.name,e[2]);b=f.dirty;if(!d){f.endEdit()}return b},onSave:function(){if(!this.formPanel.form.isValid()){return}if(!this.updateRecord()){this.onCancel();return}this.fireEvent(this.activeRecord.phantom?"eventadd":"eventupdate",this,this.activeRecord,this.animateTarget)},onDelete:function(){this.fireEvent("eventdelete",this,this.activeRecord,this.animateTarget)}});Ext.reg("extensible.eventeditwindow",Ext.ensible.cal.EventEditWindow);