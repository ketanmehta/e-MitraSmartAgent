/*!
 * Extensible 1.0.2
 * Copyright(c) 2010-2012 Extensible, LLC
 * licensing@ext.ensible.com
 * http://ext.ensible.com
 */
Ext.ensible.cal.RecurrenceField=Ext.extend(Ext.form.Field,{fieldLabel:"Repeats",startDate:new Date().clearTime(),enableFx:true,initComponent:function(){Ext.ensible.cal.RecurrenceField.superclass.initComponent.call(this);if(!this.height){this.autoHeight=true}},onRender:function(b,a){if(!this.el){this.frequencyCombo=new Ext.ensible.cal.RecurrenceCombo({id:this.id+"-frequency",listeners:{recurrencechange:{fn:this.showOptions,scope:this}}});if(this.fieldLabel){this.frequencyCombo.fieldLabel=this.fieldLabel}this.innerCt=new Ext.Container({cls:"extensible-recur-inner-ct",items:[]});this.fieldCt=new Ext.Container({autoEl:{id:this.id},cls:"extensible-recur-ct",renderTo:b,items:[this.frequencyCombo,this.innerCt]});this.fieldCt.ownerCt=this;this.innerCt.ownerCt=this.fieldCt;this.el=this.fieldCt.getEl();this.items=new Ext.util.MixedCollection();this.items.addAll(this.initSubComponents())}Ext.ensible.cal.RecurrenceField.superclass.onRender.call(this,b,a)},initValue:function(){this.setStartDate(this.startDate);if(this.value!==undefined){this.setValue(this.value)}else{if(this.frequency!==undefined){this.setValue("FREQ="+this.frequency)}else{this.setValue("NONE")}}this.originalValue=this.getValue()},showOptions:function(c){var b=false,a="day";if(c!="NONE"){this.hideSubPanels()}this.frequency=c;switch(c){case"DAILY":b=this.showSubPanel(this.repeatEvery);b|=this.showSubPanel(this.until);break;case"WEEKLY":b=this.showSubPanel(this.repeatEvery);b|=this.showSubPanel(this.weekly);b|=this.showSubPanel(this.until);a="week";break;case"MONTHLY":b=this.showSubPanel(this.repeatEvery);b|=this.showSubPanel(this.monthly);b|=this.showSubPanel(this.until);a="month";break;case"YEARLY":b=this.showSubPanel(this.repeatEvery);b|=this.showSubPanel(this.yearly);b|=this.showSubPanel(this.until);a="year";break;default:this.hideInnerCt();return}if(b){this.innerCt.doLayout()}this.showInnerCt();this.repeatEvery.updateLabel(a)},showSubPanel:function(a){if(a.rendered){a.show();return false}else{if(this.repeatEvery.rendered){a=this.innerCt.insert(1,a)}else{a=this.innerCt.add(a)}a.show();return true}},showInnerCt:function(){if(!this.innerCt.isVisible()){if(this.enableFx&&Ext.enableFx){this.innerCt.getPositionEl().slideIn("t",{duration:0.3})}else{this.innerCt.show()}}},hideInnerCt:function(){if(this.innerCt.isVisible()){if(this.enableFx&&Ext.enableFx){this.innerCt.getPositionEl().slideOut("t",{duration:0.3,easing:"easeIn",callback:this.hideSubPanels,scope:this})}else{this.innerCt.hide();this.hideSubPanels()}}},setStartDate:function(a){this.items.each(function(b){b.setStartDate(a)})},getValue:function(){if(!this.rendered){return this.value}if(this.frequency=="NONE"){return""}var a="FREQ="+this.frequency;this.items.each(function(b){if(b.isVisible()){a+=b.getValue()}});return a},setValue:function(a){this.value=a;if(a==null||a==""||a=="NONE"){this.frequencyCombo.setValue("NONE");this.showOptions("NONE");return this}var b=a.split(";");this.items.each(function(c){c.setValue(b)});Ext.each(b,function(d){if(d.indexOf("FREQ")>-1){var c=d.split("=")[1];this.frequencyCombo.setValue(c);this.showOptions(c);return}},this);return this},hideSubPanels:function(){this.items.each(function(a){a.hide()})},initSubComponents:function(){Ext.ensible.cal.recurrenceBase=Ext.extend(Ext.Container,{fieldLabel:" ",labelSeparator:"",hideLabel:true,layout:"table",anchor:"100%",startDate:this.startDate,getSuffix:function(a){if(!Ext.isNumber(a)){return""}switch(a){case 1:case 21:case 31:return"st";case 2:case 22:return"nd";case 3:case 23:return"rd";default:return"th"}},initNthCombo:function(h){var h=Ext.getCmp(this.id+"-combo"),b=this.startDate,l=h.getStore(),m=b.getLastDateOfMonth().getDate(),c=b.getDate(),n=b.format("jS")+" day",g=this.id.indexOf("-yearly")>-1,j=" in "+b.format("F"),f,d,i,a,k,e,o;f=Math.ceil(c/7);d=f+this.getSuffix(f)+b.format(" l");if(g){n+=j;d+=j}e=[[n],[d]];o=g?j:"";if(m-c<7){e.push(["last "+b.format("l")+o])}if(m==c){e.push(["last day"+o])}k=l.find("field1",h.getValue());l.removeAll();h.clearValue();l.loadData(e);if(k>e.length-1){k=e.length-1}h.setValue(l.getAt(k>-1?k:0).data.field1);return this},setValue:Ext.emptyFn});this.repeatEvery=new Ext.ensible.cal.recurrenceBase({id:this.id+"-every",layoutConfig:{columns:3},items:[{xtype:"label",text:"Repeat every"},{xtype:"numberfield",id:this.id+"-every-num",value:1,width:35,minValue:1,maxValue:99,allowBlank:false,enableKeyEvents:true,listeners:{keyup:{fn:function(){this.repeatEvery.updateLabel()},scope:this}}},{xtype:"label",id:this.id+"-every-label"}],setStartDate:function(a){this.startDate=a;this.updateLabel();return this},getValue:function(){var a=Ext.getCmp(this.id+"-num").getValue();return a>1?";INTERVAL="+a:""},setValue:function(a){var c=false,b=Ext.isArray(a)?a:a.split(";");Ext.each(b,function(e){if(e.indexOf("INTERVAL")>-1){var d=e.split("=")[1];Ext.getCmp(this.id+"-num").setValue(d)}},this);return this},updateLabel:function(b){if(this.rendered){var a=Ext.getCmp(this.id+"-num").getValue()==1?"":"s";this.type=b?b.toLowerCase():this.type||"day";var c=Ext.getCmp(this.id+"-label");if(c.rendered){c.update(this.type+a+" beginning "+this.startDate.format("l, F j"))}}return this},afterRender:function(){Ext.ensible.cal.recurrenceBase.superclass.afterRender.call(this);this.updateLabel()}});this.weekly=new Ext.ensible.cal.recurrenceBase({id:this.id+"-weekly",layoutConfig:{columns:2},items:[{xtype:"label",text:"on:"},{xtype:"checkboxgroup",id:this.id+"-weekly-days",items:[{boxLabel:"Sun",name:"SU",id:this.id+"-weekly-SU"},{boxLabel:"Mon",name:"MO",id:this.id+"-weekly-MO"},{boxLabel:"Tue",name:"TU",id:this.id+"-weekly-TU"},{boxLabel:"Wed",name:"WE",id:this.id+"-weekly-WE"},{boxLabel:"Thu",name:"TH",id:this.id+"-weekly-TH"},{boxLabel:"Fri",name:"FR",id:this.id+"-weekly-FR"},{boxLabel:"Sat",name:"SA",id:this.id+"-weekly-SA"}]}],setStartDate:function(a){this.startDate=a;this.selectToday();return this},selectToday:function(){this.clearValue();var a=this.startDate.format("D").substring(0,2).toUpperCase();Ext.getCmp(this.id+"-days").setValue(a,true)},clearValue:function(){Ext.getCmp(this.id+"-days").setValue([false,false,false,false,false,false,false])},getValue:function(){var b="",c=Ext.getCmp(this.id+"-days").getValue();Ext.each(c,function(d){if(b.length>0){b+=","}b+=d.name});var a=this.startDate.format("D").substring(0,2).toUpperCase();return b.length>0&&b!=a?";BYDAY="+b:""},setValue:function(a){var c=false,b=Ext.isArray(a)?a:a.split(";");this.clearValue();Ext.each(b,function(e){if(e.indexOf("BYDAY")>-1){var f=e.split("=")[1].split(","),d={};Ext.each(f,function(g){d[g]=true},this);Ext.getCmp(this.id+"-days").setValue(d);return c=true}},this);if(!c){this.selectToday()}return this}});this.monthly=new Ext.ensible.cal.recurrenceBase({id:this.id+"-monthly",layoutConfig:{columns:3},items:[{xtype:"label",text:"on the"},{xtype:"combo",id:this.id+"-monthly-combo",mode:"local",width:150,triggerAction:"all",forceSelection:true,store:[]},{xtype:"label",text:"of each month"}],setStartDate:function(a){this.startDate=a;this.initNthCombo();return this},getValue:function(){var e=Ext.getCmp(this.id+"-combo"),c=e.getStore(),a=c.find("field1",e.getValue()),d=this.startDate,b=d.format("D").substring(0,2).toUpperCase();if(a>-1){switch(a){case 0:return";BYMONTHDAY="+d.format("j");case 1:return";BYDAY="+e.getValue()[0].substring(0,1)+b;case 2:return";BYDAY=-1"+b;default:return";BYMONTHDAY=-1"}}return""}});this.yearly=new Ext.ensible.cal.recurrenceBase({id:this.id+"-yearly",layoutConfig:{columns:3},items:[{xtype:"label",text:"on the"},{xtype:"combo",id:this.id+"-yearly-combo",mode:"local",width:170,triggerAction:"all",forceSelection:true,store:[]},{xtype:"label",text:"each year"}],setStartDate:function(a){this.startDate=a;this.initNthCombo();return this},getValue:function(){var e=Ext.getCmp(this.id+"-combo"),c=e.getStore(),a=c.find("field1",e.getValue()),d=this.startDate,b=d.format("D").substring(0,2).toUpperCase(),f=";BYMONTH="+d.format("n");if(a>-1){switch(a){case 0:return f;case 1:return f+";BYDAY="+e.getValue()[0].substring(0,1)+b;case 2:return f+";BYDAY=-1"+b;default:return f+";BYMONTHDAY=-1"}}return""}});this.until=new Ext.ensible.cal.recurrenceBase({id:this.id+"-until",untilDateFormat:"Ymd\\T000000\\Z",layoutConfig:{columns:5},items:[{xtype:"label",text:"and continuing"},{xtype:"combo",id:this.id+"-until-combo",mode:"local",width:85,triggerAction:"all",forceSelection:true,value:"forever",store:["forever","for","until"],listeners:{select:{fn:function(b,c){var a=Ext.getCmp(this.id+"-until-date");if(c.data.field1=="until"){a.show();if(a.getValue()==""){a.setValue(this.startDate.add(Date.DAY,5));a.setMinValue(this.startDate.clone().add(Date.DAY,1))}}else{a.hide()}if(c.data.field1=="for"){Ext.getCmp(this.id+"-until-num").show();Ext.getCmp(this.id+"-until-endlabel").show()}else{Ext.getCmp(this.id+"-until-num").hide();Ext.getCmp(this.id+"-until-endlabel").hide()}},scope:this}}},{xtype:"datefield",id:this.id+"-until-date",showToday:false,hidden:true},{xtype:"numberfield",id:this.id+"-until-num",value:5,width:35,minValue:1,maxValue:99,allowBlank:false,hidden:true},{xtype:"label",id:this.id+"-until-endlabel",text:"occurrences",hidden:true}],setStartDate:function(a){this.startDate=a;return this},getValue:function(){var b=Ext.getCmp(this.id+"-date");if(b.isVisible()){return";UNTIL="+b.getValue().format(this.untilDateFormat)}var a=Ext.getCmp(this.id+"-num");if(a.isVisible()){return";COUNT="+a.getValue()}return""},setValue:function(a){var c=false,b=Ext.isArray(a)?a:a.split(";");Ext.each(b,function(f){if(f.indexOf("COUNT")>-1){var e=f.split("=")[1];Ext.getCmp(this.id+"-combo").setValue("for");Ext.getCmp(this.id+"-num").setValue(e).show();Ext.getCmp(this.id+"-endlabel").show()}else{if(f.indexOf("UNTIL")>-1){var d=f.split("=")[1];Ext.getCmp(this.id+"-combo").setValue("until");Ext.getCmp(this.id+"-date").setValue(Date.parseDate(d,this.untilDateFormat)).show();Ext.getCmp(this.id+"-endlabel").hide()}}},this);return this}});return[this.repeatEvery,this.weekly,this.monthly,this.yearly,this.until]}});Ext.reg("extensible.recurrencefield",Ext.ensible.cal.RecurrenceField);