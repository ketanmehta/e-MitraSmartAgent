/*!
 * Extensible 1.0.2
 * Copyright(c) 2010-2012 Extensible, LLC
 * licensing@ext.ensible.com
 * http://ext.ensible.com
 */
Ext.ensible.cal.CalendarPanel=Ext.extend(Ext.Panel,{enableRecurrence:false,showDayView:true,showMultiDayView:false,showWeekView:true,showMultiWeekView:true,showMonthView:true,showNavBar:true,todayText:"Today",showTodayText:true,showTime:true,readOnly:false,showNavToday:true,showNavJump:true,showNavNextPrev:true,jumpToText:"Jump to:",goText:"Go",dayText:"Day",multiDayText:"{0} Days",weekText:"Week",multiWeekText:"{0} Weeks",monthText:"Month",editModal:false,enableEditDetails:true,layoutConfig:{layoutOnCardChange:true,deferredRender:true},startDate:new Date(),initComponent:function(){this.tbar={cls:"ext-cal-toolbar",border:true,items:[]};this.viewCount=0;var b=(this.multiDayViewCfg&&this.multiDayViewCfg.dayCount)||3,f=(this.multiWeekViewCfg&&this.multiWeekViewCfg.weekCount)||2;if(this.showNavToday){this.tbar.items.push({id:this.id+"-tb-today",text:this.todayText,handler:this.onTodayClick,scope:this})}if(this.showNavNextPrev){this.tbar.items.push([{id:this.id+"-tb-prev",handler:this.onPrevClick,scope:this,iconCls:"x-tbar-page-prev"},{id:this.id+"-tb-next",handler:this.onNextClick,scope:this,iconCls:"x-tbar-page-next"}])}if(this.showNavJump){this.tbar.items.push([this.jumpToText,{id:this.id+"-tb-jump-dt",xtype:"datefield",showToday:false},{id:this.id+"-tb-jump",text:this.goText,handler:this.onJumpClick,scope:this}])}this.tbar.items.push("->");if(this.showDayView){this.tbar.items.push({id:this.id+"-tb-day",text:this.dayText,handler:this.onDayNavClick,scope:this,toggleGroup:this.id+"-tb-views"});this.viewCount++}if(this.showMultiDayView){var h=String.format(this.getMultiDayText(b),b);this.tbar.items.push({id:this.id+"-tb-multiday",text:h,handler:this.onMultiDayNavClick,scope:this,toggleGroup:this.id+"-tb-views"});this.viewCount++}if(this.showWeekView){this.tbar.items.push({id:this.id+"-tb-week",text:this.weekText,handler:this.onWeekNavClick,scope:this,toggleGroup:this.id+"-tb-views"});this.viewCount++}if(this.showMultiWeekView){var h=String.format(this.getMultiWeekText(f),f);this.tbar.items.push({id:this.id+"-tb-multiweek",text:h,handler:this.onMultiWeekNavClick,scope:this,toggleGroup:this.id+"-tb-views"});this.viewCount++}if(this.showMonthView||this.viewCount==0){this.tbar.items.push({id:this.id+"-tb-month",text:this.monthText,handler:this.onMonthNavClick,scope:this,toggleGroup:this.id+"-tb-views"});this.viewCount++;this.showMonthView=true}var g=this.viewCount-1;this.activeItem=this.activeItem===undefined?g:(this.activeItem>g?g:this.activeItem);if(this.showNavBar===false){delete this.tbar;this.addClass("x-calendar-nonav")}Ext.ensible.cal.CalendarPanel.superclass.initComponent.call(this);this.addEvents({eventadd:true,eventupdate:true,beforeeventdelete:true,eventdelete:true,eventcancel:true,viewchange:true,editdetails:true});this.layout="card";this.addClass("x-cal-panel");if(this.eventStore){this.store=this.eventStore;delete this.eventStore}this.setStore(this.store);var i={showToday:this.showToday,todayText:this.todayText,showTodayText:this.showTodayText,showTime:this.showTime,readOnly:this.readOnly,enableRecurrence:this.enableRecurrence,store:this.store,calendarStore:this.calendarStore,editModal:this.editModal,enableEditDetails:this.enableEditDetails,ownerCalendarPanel:this};if(this.showDayView){var e=Ext.apply({xtype:"extensible.dayview",title:this.dayText},i);e=Ext.apply(Ext.apply(e,this.viewConfig),this.dayViewCfg);e.id=this.id+"-day";this.initEventRelay(e);this.add(e)}if(this.showMultiDayView){var a=Ext.apply({xtype:"extensible.multidayview",title:this.getMultiDayText(b)},i);a=Ext.apply(Ext.apply(a,this.viewConfig),this.multiDayViewCfg);a.id=this.id+"-multiday";this.initEventRelay(a);this.add(a)}if(this.showWeekView){var j=Ext.applyIf({xtype:"extensible.weekview",title:this.weekText},i);j=Ext.apply(Ext.apply(j,this.viewConfig),this.weekViewCfg);j.id=this.id+"-week";this.initEventRelay(j);this.add(j)}if(this.showMultiWeekView){var d=Ext.applyIf({xtype:"extensible.multiweekview",title:this.getMultiWeekText(f)},i);d=Ext.apply(Ext.apply(d,this.viewConfig),this.multiWeekViewCfg);d.id=this.id+"-multiweek";this.initEventRelay(d);this.add(d)}if(this.showMonthView){var c=Ext.applyIf({xtype:"extensible.monthview",title:this.monthText,listeners:{weekclick:{fn:function(l,k){this.showWeek(k)},scope:this}}},i);c=Ext.apply(Ext.apply(c,this.viewConfig),this.monthViewCfg);c.id=this.id+"-month";this.initEventRelay(c);this.add(c)}this.add(Ext.applyIf({xtype:"extensible.eventeditform",id:this.id+"-edit",calendarStore:this.calendarStore,enableRecurrence:this.enableRecurrence,listeners:{eventadd:{scope:this,fn:this.onEventAdd},eventupdate:{scope:this,fn:this.onEventUpdate},eventdelete:{scope:this,fn:this.onEventDelete},eventcancel:{scope:this,fn:this.onEventCancel}}},this.editViewCfg))},initEventRelay:function(a){a.listeners=a.listeners||{};a.listeners.afterrender={fn:function(b){this.relayEvents(b,["eventsrendered","eventclick","dayclick","eventover","eventout","beforedatechange","datechange","rangeselect","beforeeventmove","eventmove","initdrag","dayover","dayout","beforeeventresize","eventresize","eventadd","eventupdate","beforeeventdelete","eventdelete","eventcancel"]);b.on("editdetails",this.onEditDetails,this)},scope:this,single:true}},afterRender:function(){Ext.ensible.cal.CalendarPanel.superclass.afterRender.call(this);this.body.addClass("x-cal-body");(function(){this.updateNavState();this.setActiveView()}).defer(1,this)},onLayout:function(){Ext.ensible.cal.CalendarPanel.superclass.onLayout.call(this);if(!this.navInitComplete){this.updateNavState();this.navInitComplete=true}},getMultiDayText:function(a){return this.multiDayText},getMultiWeekText:function(a){return this.multiWeekText},setStore:function(a,b){var c=this.store;if(!b&&c){c.un("write",this.onWrite,this)}if(a){a.on("write",this.onWrite,this)}this.store=a},onStoreAdd:function(c,b,a){var d=Ext.isArray(b)?b[0]:b;if(d.phantom){return}this.hideEditForm()},onStoreUpdate:function(b,c,a){if(a==Ext.data.Record.COMMIT){this.hideEditForm()}},onStoreRemove:function(a,b){this.hideEditForm()},onWrite:function(a,c,b,e,d){switch(c){case"create":this.onStoreAdd(a,d);break;case"update":this.onStoreUpdate(a,d,Ext.data.Record.COMMIT);break;case"destroy":this.onStoreRemove(a,d);break}},onEditDetails:function(b,c,a){if(this.fireEvent("editdetails",this,b,c,a)!==false){this.showEditForm(c)}},save:function(){if(!this.store.autoSave){this.store.save()}},onEventAdd:function(a,b){if(!b.store){this.store.add(b);this.save()}this.fireEvent("eventadd",this,b)},onEventUpdate:function(a,b){this.save();this.fireEvent("eventupdate",this,b)},onEventDelete:function(a,b){this.store.remove(b);this.save();this.fireEvent("eventdelete",this,b)},onEventCancel:function(a,b){this.hideEditForm();this.fireEvent("eventcancel",this,b)},showEditForm:function(a){this.preEditView=this.layout.activeItem.id;this.setActiveView(this.id+"-edit");this.layout.activeItem.loadRecord(a);return this},hideEditForm:function(){if(this.preEditView){this.setActiveView(this.preEditView);delete this.preEditView}return this},setActiveView:function(f,a){var e=this,d=e.layout,b=e.id+"-edit",c;if(a){e.startDate=a}if(f!==d.activeItem.id){c=e.getTopToolbar();if(c){c[f===b?"hide":"show"]()}d.setActiveItem(f||e.activeItem);e.doLayout();e.activeView=d.activeItem;if(f!==b){if(f&&f!==e.preEditView){d.activeItem.setStartDate(e.startDate,true)}e.updateNavState()}e.fireViewChange()}},fireViewChange:function(){var c=null,a=this.layout.activeItem;if(a.getViewBounds){var b=a.getViewBounds(),c={activeDate:a.getStartDate(),viewStart:b.start,viewEnd:b.end}}if(a.dismissEventEditor){a.dismissEventEditor()}this.fireEvent("viewchange",this,a,c)},updateNavState:function(){var b=this,d=b.layout.activeItem;if(d&&b.showNavBar!==false){var c=d.id.split(b.id+"-")[1],a=Ext.getCmp(b.id+"-tb-"+c);if(b.showNavToday){Ext.getCmp(b.id+"-tb-today").setDisabled(d.isToday())}a.toggle(true)}},setStartDate:function(a){Ext.ensible.log("setStartDate (CalendarPanel");this.startDate=a;this.layout.activeItem.setStartDate(a,true);this.updateNavState();this.fireViewChange();return this},showWeek:function(a){this.setActiveView(this.id+"-week",a)},onTodayClick:function(){this.startDate=this.layout.activeItem.moveToday(true);this.updateNavState();this.fireViewChange()},onJumpClick:function(){var a=Ext.getCmp(this.id+"-tb-jump-dt").getValue();if(a!==""){this.startDate=this.layout.activeItem.moveTo(a,true);this.updateNavState();this.fireViewChange()}},onPrevClick:function(){this.startDate=this.layout.activeItem.movePrev(true);this.updateNavState();this.fireViewChange()},onNextClick:function(){this.startDate=this.layout.activeItem.moveNext(true);this.updateNavState();this.fireViewChange()},onDayNavClick:function(){this.setActiveView(this.id+"-day")},onMultiDayNavClick:function(){this.setActiveView(this.id+"-multiday")},onWeekNavClick:function(){this.setActiveView(this.id+"-week")},onMultiWeekNavClick:function(){this.setActiveView(this.id+"-multiweek")},onMonthNavClick:function(){this.setActiveView(this.id+"-month")},getActiveView:function(){return this.layout.activeItem}});Ext.reg("extensible.calendarpanel",Ext.ensible.cal.CalendarPanel);