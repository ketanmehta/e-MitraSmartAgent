/*!
 * Extensible 1.0.2
 * Copyright(c) 2010-2012 Extensible, LLC
 * licensing@ext.ensible.com
 * http://ext.ensible.com
 */
Ext.ensible.cal.DayBodyView=Ext.extend(Ext.ensible.cal.CalendarView,{dayColumnElIdDelimiter:"-day-col-",hourIncrement:60,initComponent:function(){Ext.ensible.cal.DayBodyView.superclass.initComponent.call(this);if(this.readOnly===true){this.enableEventResize=false}this.incrementsPerHour=this.hourIncrement/this.ddIncrement;this.minEventHeight=this.minEventDisplayMinutes/(this.hourIncrement/this.hourHeight);this.addEvents({beforeeventresize:true,eventresize:true,dayclick:true})},initDD:function(){var a={view:this,createText:this.ddCreateEventText,moveText:this.ddMoveEventText,resizeText:this.ddResizeEventText,ddIncrement:this.ddIncrement,ddGroup:this.ddGroup||this.id+"-DayViewDD"};this.el.ddScrollConfig={vthresh:Ext.isIE||Ext.isOpera?100:40,hthresh:-1,frequency:50,increment:100,ddGroup:this.ddGroup||this.id+"-DayViewDD"};this.dragZone=new Ext.ensible.cal.DayViewDragZone(this.el,Ext.apply({containerScroll:true},a));this.dropZone=new Ext.ensible.cal.DayViewDropZone(this.el,a)},refresh:function(a){Ext.ensible.log("refresh (DayBodyView)");var b=this.el.getScroll().top;Ext.ensible.cal.DayBodyView.superclass.refresh.call(this,a);if(this.scrollReady){this.scrollTo(b)}},scrollTo:function(b,a){a=a||(Ext.isIE||Ext.isOpera);if(a){(function(){this.el.scrollTo("top",b);this.scrollReady=true}).defer(10,this)}else{this.el.scrollTo("top",b);this.scrollReady=true}},afterRender:function(){if(!this.tpl){this.tpl=new Ext.ensible.cal.DayBodyTemplate({id:this.id,dayCount:this.dayCount,showTodayText:this.showTodayText,todayText:this.todayText,showTime:this.showTime,showHourSeparator:this.showHourSeparator,viewStartHour:this.viewStartHour,viewEndHour:this.viewEndHour,hourIncrement:this.hourIncrement,hourHeight:this.hourHeight})}this.tpl.compile();this.addClass("ext-cal-body-ct");Ext.ensible.cal.DayBodyView.superclass.afterRender.call(this);var b=Math.max(this.scrollStartHour,this.viewStartHour),a=Math.max(0,b-this.viewStartHour);if(a>0){this.scrollTo(a*this.hourHeight)}},forceSize:Ext.emptyFn,onEventResize:function(d,b){if(this.fireEvent("beforeeventresize",this,d,b)!==false){var c=Ext.ensible.Date,e=Ext.ensible.cal.EventMappings.StartDate.name,a=Ext.ensible.cal.EventMappings.EndDate.name;if(c.compare(d.data[e],b.StartDate)===0&&c.compare(d.data[a],b.EndDate)===0){return}d.set(e,b.StartDate);d.set(a,b.EndDate);this.onEventUpdate(null,d);this.fireEvent("eventresize",this,d)}},getEventBodyMarkup:function(){if(!this.eventBodyMarkup){this.eventBodyMarkup=["{Title}",'<tpl if="_isReminder">','<i class="ext-cal-ic ext-cal-ic-rem">&#160;</i>',"</tpl>",'<tpl if="_isRecurring">','<i class="ext-cal-ic ext-cal-ic-rcr">&#160;</i>',"</tpl>"].join("")}return this.eventBodyMarkup},getEventTemplate:function(){if(!this.eventTpl){this.eventTpl=!(Ext.isIE||Ext.isOpera)?new Ext.XTemplate('<div id="{_elId}" class="{_extraCls} ext-cal-evt ext-cal-evr" style="left: {_left}%; width: {_width}%; top: {_top}px; height: {_height}px;">','<div class="ext-evt-bd">',this.getEventBodyMarkup(),"</div>",this.enableEventResize?'<div class="ext-evt-rsz"><div class="ext-evt-rsz-h">&#160;</div></div>':"","</div>"):new Ext.XTemplate('<div id="{_elId}" class="ext-cal-evt {_extraCls}" style="left: {_left}%; width: {_width}%; top: {_top}px;">','<div class="ext-cal-evb">&#160;</div>','<dl style="height: {_height}px;" class="ext-cal-evdm">','<dd class="ext-evt-bd">',this.getEventBodyMarkup(),"</dd>",this.enableEventResize?'<div class="ext-evt-rsz"><div class="ext-evt-rsz-h">&#160;</div></div>':"","</dl>",'<div class="ext-cal-evb">&#160;</div>',"</div>");this.eventTpl.compile()}return this.eventTpl},getEventAllDayTemplate:function(){if(!this.eventAllDayTpl){var b,a=this.getEventBodyMarkup();b=!(Ext.isIE||Ext.isOpera)?new Ext.XTemplate('<div class="{_extraCls} {spanCls} ext-cal-evt ext-cal-evr" style="left: {_left}%; width: {_width}%; top: {_top}px; height: {_height}px;">',a,"</div>"):new Ext.XTemplate('<div class="ext-cal-evt" style="left: {_left}%; width: {_width}%; top: {_top}px; height: {_height}px;">','<div class="{_extraCls} {spanCls} ext-cal-evo">','<div class="ext-cal-evm">','<div class="ext-cal-evi">',a,"</div>","</div>","</div></div>");b.compile();this.eventAllDayTpl=b}return this.eventAllDayTpl},getTemplateEventData:function(i){var g=Ext.ensible.cal.EventMappings,e=[this.getEventSelectorCls(i[g.EventId.name])],f={},a="x-cal-default",h=i[g.Title.name],c=Ext.ensible.Date.use24HourTime?"G:i ":"g:ia ",b=i[g.RRule.name]!="";this.getTemplateEventBox(i);if(this.calendarStore&&i[g.CalendarId.name]){var d=this.calendarStore.getById(i[g.CalendarId.name]);if(d){a="x-cal-"+d.data[Ext.ensible.cal.CalendarMappings.ColorId.name]}}a+=(i._renderAsAllDay?"-ad":"")+(Ext.isIE||Ext.isOpera?"-x":"");e.push(a);if(this.getEventClass){var d=this.getEventRecord(i[g.EventId.name]),k=this.getEventClass(d,!!i._renderAsAllDay,f,this.store);e.push(k)}f._extraCls=e.join(" ");f._isRecurring=i.Recurrence&&i.Recurrence!="";f._isReminder=i[g.Reminder.name]&&i[g.Reminder.name]!="";f.Title=(i[g.IsAllDay.name]?"":i[g.StartDate.name].format(c))+(!h||h.length==0?this.defaultEventTitleText:h);return Ext.applyIf(f,i)},getEventPositionOffsets:function(){return{top:1,height:-2}},getTemplateEventBox:function(i){var c=this.hourHeight/this.hourIncrement,b=i[Ext.ensible.cal.EventMappings.StartDate.name],d=i[Ext.ensible.cal.EventMappings.EndDate.name],g=Math.max(b.getHours()-this.viewStartHour,0),h=Math.min(d.getHours()-this.viewStartHour,this.viewEndHour-this.viewStartHour),a=g*this.hourIncrement,e=h*this.hourIncrement,k=d.clearTime(true).add(Date.HOUR,this.viewEndHour),f=this.getEventPositionOffsets();if(b.getHours()>=this.viewStartHour){a+=b.getMinutes()}if(d<=k){e+=d.getMinutes()}i._left=0;i._width=100;i._top=a*c+f.top;i._height=Math.max(((e-a)*c),this.minEventHeight)+f.height},renderItems:function(){var o=0,c=[];for(;o<this.dayCount;o++){var t=emptyCells=skipped=0,u=this.eventGrid[0][o],b=u?u.length:0,g;for(;t<b;t++){g=u[t];if(!g){continue}var s=g.data||g.event.data,e=Ext.ensible.cal.EventMappings,v=s[e.IsAllDay.name]===true,n=Ext.ensible.Date.diffDays(s[e.StartDate.name],s[e.EndDate.name])>0,f=v||n;if(f){continue}Ext.apply(s,{cls:"ext-cal-ev",_positioned:true});c.push({data:this.getTemplateEventData(s),date:this.viewStart.add(Date.DAY,o)})}}var p=j=0,q=[],k=c.length,a;for(;p<k;p++){var g=c[p].data,m=null,h=g[Ext.ensible.cal.EventMappings.StartDate.name].getDate();for(j=0;j<k;j++){if(p==j){continue}m=c[j].data;if(this.isOverlapping(g,m)){g._overlap=g._overlap==undefined?1:g._overlap+1;if(p<j){if(g._overcol===undefined){g._overcol=0}m._overcol=g._overcol+1;q[h]=q[h]?Math.max(q[h],m._overcol):m._overcol}}}}for(p=0;p<k;p++){var g=c[p].data,h=g[Ext.ensible.cal.EventMappings.StartDate.name].getDate();if(g._overlap!==undefined){var w=100/(q[h]+1),y=100-(w*g._overlap);g._width=w;g._left=w*g._overcol}var r=this.getEventTemplate().apply(g),x=this.id+"-day-col-"+c[p].date.format("Ymd");Ext.DomHelper.append(x,r)}this.fireEvent("eventsrendered",this)},getDayEl:function(a){return Ext.get(this.getDayId(a))},getDayId:function(a){if(Ext.isDate(a)){a=a.format("Ymd")}return this.id+this.dayColumnElIdDelimiter+a},getDaySize:function(){var a=this.el.child(".ext-cal-day-col-inner").getBox();return{height:a.height,width:a.width}},getDayAt:function(n,i){var e=".ext-cal-body-ct",g=this.el.child(".ext-cal-day-times").getWidth(),r=this.el.getBox(),m=this.getDaySize(false),o=n-r.x-g,a=Math.floor(o/m.width),l=this.el.getScroll(),q=this.el.child(".ext-cal-bg-row"),p=q.getHeight()/this.incrementsPerHour,k=i-r.y-p+l.top,h=Math.max(0,Math.ceil(k/p)),b=h*(this.hourIncrement/this.incrementsPerHour),d=this.viewStart.add(Date.DAY,a).add(Date.MINUTE,b).add(Date.HOUR,this.viewStartHour),c=this.getDayEl(d),f=n;if(c){f=c.getLeft()}return{date:d,el:c,timeBox:{x:f,y:(h*this.hourHeight/this.incrementsPerHour)+r.y-l.top,width:m.width,height:p}}},onClick:function(f,b){if(this.dragPending||Ext.ensible.cal.DayBodyView.superclass.onClick.apply(this,arguments)){return}if(f.getTarget(".ext-cal-day-times",3)!==null){return}var c=f.getTarget("td",3);if(c){if(c.id&&c.id.indexOf(this.dayElIdDelimiter)>-1){var d=this.getDateFromId(c.id,this.dayElIdDelimiter);this.onDayClick(Date.parseDate(d,"Ymd"),true,Ext.get(this.getDayId(d)));return}}var a=this.getDayAt(f.xy[0],f.xy[1]);if(a&&a.date){this.onDayClick(a.date,false,null)}}});Ext.reg("extensible.daybodyview",Ext.ensible.cal.DayBodyView);