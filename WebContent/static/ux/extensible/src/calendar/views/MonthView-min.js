/*!
 * Extensible 1.0.2
 * Copyright(c) 2010-2012 Extensible, LLC
 * licensing@ext.ensible.com
 * http://ext.ensible.com
 */
Ext.ensible.cal.MonthView=Ext.extend(Ext.ensible.cal.CalendarView,{moreText:"+{0} more...",detailsTitleDateFormat:"F j",showTime:true,showTodayText:true,showHeader:false,showWeekLinks:false,showWeekNumbers:false,weekLinkOverClass:"ext-week-link-over",daySelector:".ext-cal-day",moreSelector:".ext-cal-ev-more",weekLinkSelector:".ext-cal-week-link",weekCount:-1,dayCount:7,moreElIdDelimiter:"-more-",weekLinkIdDelimiter:"ext-cal-week-",initComponent:function(){Ext.ensible.cal.MonthView.superclass.initComponent.call(this);this.addEvents({dayclick:true,weekclick:true,dayover:true,dayout:true})},initDD:function(){var a={view:this,createText:this.ddCreateEventText,moveText:this.ddMoveEventText,ddGroup:this.ddGroup||this.id+"-MonthViewDD"};this.dragZone=new Ext.ensible.cal.DragZone(this.el,a);this.dropZone=new Ext.ensible.cal.DropZone(this.el,a)},onDestroy:function(){Ext.destroy(this.ddSelector);Ext.destroy(this.dragZone);Ext.destroy(this.dropZone);Ext.ensible.cal.MonthView.superclass.onDestroy.call(this)},afterRender:function(){if(!this.tpl){this.tpl=new Ext.ensible.cal.MonthViewTemplate({id:this.id,showTodayText:this.showTodayText,todayText:this.todayText,showTime:this.showTime,showHeader:this.showHeader,showWeekLinks:this.showWeekLinks,showWeekNumbers:this.showWeekNumbers})}this.tpl.compile();this.addClass("ext-cal-monthview ext-cal-ct");Ext.ensible.cal.MonthView.superclass.afterRender.call(this)},onResize:function(){if(this.monitorResize){this.maxEventsPerDay=this.getMaxEventsPerDay();this.refresh()}},forceSize:function(){if(this.showWeekLinks&&this.el&&this.el.child){var e=this.el.select(".ext-cal-hd-days-tbl"),d=this.el.select(".ext-cal-bg-tbl"),c=this.el.select(".ext-cal-evt-tbl"),b=this.el.child(".ext-cal-week-link").getWidth(),a=this.el.getWidth()-b;e.setWidth(a);d.setWidth(a);c.setWidth(a)}Ext.ensible.cal.MonthView.superclass.forceSize.call(this)},initClock:function(){if(Ext.fly(this.id+"-clock")!==null){this.prevClockDay=new Date().getDay();if(this.clockTask){Ext.TaskMgr.stop(this.clockTask)}this.clockTask=Ext.TaskMgr.start({run:function(){var b=Ext.fly(this.id+"-clock"),a=new Date();if(a.getDay()==this.prevClockDay){if(b){b.update(a.format(Ext.ensible.Date.use24HourTime?"G:i":"g:ia"))}}else{this.prevClockDay=a.getDay();this.moveTo(a)}},scope:this,interval:1000})}},getMoreText:function(a){return this.moreText},getEventBodyMarkup:function(){if(!this.eventBodyMarkup){this.eventBodyMarkup=["{Title}",'<tpl if="_isReminder">','<i class="ext-cal-ic ext-cal-ic-rem">&#160;</i>',"</tpl>",'<tpl if="_isRecurring">','<i class="ext-cal-ic ext-cal-ic-rcr">&#160;</i>',"</tpl>",'<tpl if="spanLeft">','<i class="ext-cal-spl">&#160;</i>',"</tpl>",'<tpl if="spanRight">','<i class="ext-cal-spr">&#160;</i>',"</tpl>"].join("")}return this.eventBodyMarkup},getEventTemplate:function(){if(!this.eventTpl){var b,a=this.getEventBodyMarkup();b=!(Ext.isIE||Ext.isOpera)?new Ext.XTemplate('<div class="{_extraCls} {spanCls} ext-cal-evt ext-cal-evr">',a,"</div>"):new Ext.XTemplate('<tpl if="_renderAsAllDay">','<div class="{_extraCls} {spanCls} ext-cal-evt ext-cal-evo">','<div class="ext-cal-evm">','<div class="ext-cal-evi">',"</tpl>",'<tpl if="!_renderAsAllDay">','<div class="{_extraCls} ext-cal-evt ext-cal-evr">',"</tpl>",a,'<tpl if="_renderAsAllDay">',"</div>","</div>","</tpl>","</div>");b.compile();this.eventTpl=b}return this.eventTpl},getTemplateEventData:function(i){var g=Ext.ensible.cal.EventMappings,e=[this.getEventSelectorCls(i[g.EventId.name])],f={},b=i[g.RRule.name]!="",a="x-cal-default",h=i[g.Title.name],c=Ext.ensible.Date.use24HourTime?"G:i ":"g:ia ";if(this.calendarStore&&i[g.CalendarId.name]){var d=this.calendarStore.getById(i[g.CalendarId.name]);if(d){a="x-cal-"+d.data[Ext.ensible.cal.CalendarMappings.ColorId.name]}}a+=(i._renderAsAllDay?"-ad":"");e.push(a);if(this.getEventClass){var d=this.getEventRecord(i[g.EventId.name]),j=this.getEventClass(d,!!i._renderAsAllDay,f,this.store);e.push(j)}f._extraCls=e.join(" ");f._isRecurring=i.Recurrence&&i.Recurrence!="";f._isReminder=i[g.Reminder.name]&&i[g.Reminder.name]!="";f.Title=(i[g.IsAllDay.name]?"":i[g.StartDate.name].format(c))+(!h||h.length==0?this.defaultEventTitleText:h);return Ext.applyIf(f,i)},refresh:function(a){Ext.ensible.log("refresh (MonthView)");if(this.detailPanel){this.detailPanel.hide()}Ext.ensible.cal.MonthView.superclass.refresh.call(this,a);if(this.showTime!==false){this.initClock()}},renderItems:function(){Ext.ensible.cal.WeekEventRenderer.render({eventGrid:this.allDayOnly?this.allDayGrid:this.eventGrid,viewStart:this.viewStart,tpl:this.getEventTemplate(),maxEventsPerDay:this.maxEventsPerDay,viewId:this.id,templateDataFn:this.getTemplateEventData.createDelegate(this),evtMaxCount:this.evtMaxCount,weekCount:this.weekCount,dayCount:this.dayCount,getMoreText:this.getMoreText.createDelegate(this)});this.fireEvent("eventsrendered",this)},getDayEl:function(a){return Ext.get(this.getDayId(a))},getDayId:function(a){if(Ext.isDate(a)){a=a.format("Ymd")}return this.id+this.dayElIdDelimiter+a},getWeekIndex:function(b){var a=this.getDayEl(b).up(".ext-cal-wk-ct");return parseInt(a.id.split("-wk-")[1])},getDaySize:function(f){var c=this.el.getBox(),e=this.getViewPadding(),a=(c.width-e.width)/this.dayCount,b=(c.height-e.height)/this.getWeekCount();if(f){var d=this.el.select(".ext-cal-dtitle").last().parent("tr");b=d?b-d.getHeight(true):b}return{height:b,width:a}},getEventHeight:function(){if(!this.eventHeight){var a=this.el.select(".ext-cal-evt").first();if(a){this.eventHeight=a.parent("td").getHeight()}else{return 16}}return this.eventHeight},getMaxEventsPerDay:function(){var b=this.getDaySize(true).height,c=this.getEventHeight(),d=5,a=Math.max(Math.floor((b-c-d)/c),0);return a},getViewPadding:function(d){var d=d||"tlbr",f=d.indexOf("t")>-1,e=d.indexOf("l")>-1,b=d.indexOf("r")>-1,a=this.showHeader&&f?this.el.select(".ext-cal-hd-days-tbl").first().getHeight():0,c=0;if(this.isHeaderView){if(e){c=this.el.select(".ext-cal-gutter").first().getWidth()}if(b){c+=this.el.select(".ext-cal-gutter-rt").first().getWidth()}}else{if(this.showWeekLinks&&e){c=this.el.select(".ext-cal-week-link").first().getWidth()}}return{height:a,width:c}},getDayAt:function(h,e){var c=this.el.getBox(),f=this.getViewPadding("tl"),g=this.getDaySize(),d=Math.floor(((h-c.x-f.width)/g.width)),b=Math.floor(((e-c.y-f.height)/g.height)),i=(b*7)+d;var a=this.viewStart.add(Date.DAY,i);return{date:a,el:this.getDayEl(a)}},moveNext:function(){return this.moveMonths(1,true)},movePrev:function(){return this.moveMonths(-1,true)},onInitDrag:function(){Ext.ensible.cal.MonthView.superclass.onInitDrag.call(this);Ext.select(this.daySelector).removeClass(this.dayOverClass);if(this.detailPanel){this.detailPanel.hide()}},onMoreClick:function(a){if(!this.detailPanel){this.detailPanel=new Ext.Panel({id:this.id+"-details-panel",title:a.format(this.detailsTitleDateFormat),layout:"fit",floating:true,renderTo:Ext.getBody(),tools:[{id:"close",handler:function(d,b,c){c.hide()}}],items:{xtype:"extensible.monthdaydetailview",id:this.id+"-details-view",date:a,view:this,store:this.store,calendarStore:this.calendarStore,listeners:{eventsrendered:this.onDetailViewUpdated.createDelegate(this)}}});if(this.enableContextMenus&&this.readOnly!==true){this.detailPanel.body.on("contextmenu",this.onContextMenu,this)}}else{this.detailPanel.setTitle(a.format(this.detailsTitleDateFormat))}this.detailPanel.getComponent(this.id+"-details-view").update(a)},onDetailViewUpdated:function(g,c,h){var b=this.detailPanel,e=b.getFrameHeight(),i=this.getEventHeight(),a=e+(h*i)+3,f=this.getDayEl(c),d=f.getBox();b.setHeight(a);b.setWidth(Math.max(d.width,220));b.show();b.getPositionEl().alignTo(f,"t-t?")},onHide:function(){Ext.ensible.cal.MonthView.superclass.onHide.call(this);if(this.detailPanel){this.detailPanel.hide()}},onClick:function(d,a){if(this.detailPanel){this.detailPanel.hide()}if(el=d.getTarget(this.moreSelector,3)){var b=el.id.split(this.moreElIdDelimiter)[1];this.onMoreClick(Date.parseDate(b,"Ymd"));return}if(el=d.getTarget(this.weekLinkSelector,3)){var b=el.id.split(this.weekLinkIdDelimiter)[1];this.fireEvent("weekclick",this,Date.parseDate(b,"Ymd"));return}if(Ext.ensible.cal.MonthView.superclass.onClick.apply(this,arguments)){return}if(el=d.getTarget("td",3)){if(el.id&&el.id.indexOf(this.dayElIdDelimiter)>-1){var c=el.id.split(this.dayElIdDelimiter),b=c[c.length-1];this.onDayClick(Date.parseDate(b,"Ymd"),false,Ext.get(this.getDayId(b)));return}}},handleDayMouseEvent:function(d,a,c){var b=d.getTarget(this.weekLinkSelector,3,true);if(b){b[c=="over"?"addClass":"removeClass"](this.weekLinkOverClass);return}Ext.ensible.cal.MonthView.superclass.handleDayMouseEvent.apply(this,arguments)},destroy:function(){Ext.ensible.cal.MonthView.superclass.destroy.call(this);if(this.detailsPanel){this.detailPanel.body.un("contextmenu",this.onContextMenu,this)}}});Ext.reg("extensible.monthview",Ext.ensible.cal.MonthView);