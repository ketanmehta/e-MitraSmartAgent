/*!
 * Extensible 1.0.2
 * Copyright(c) 2010-2012 Extensible, LLC
 * licensing@ext.ensible.com
 * http://ext.ensible.com
 */
Ext.ensible.cal.CalendarView=Ext.extend(Ext.BoxComponent,{startDay:0,spansHavePriority:false,trackMouseOver:true,enableFx:true,enableAddFx:true,enableUpdateFx:false,enableRemoveFx:true,enableDD:true,enableContextMenus:true,suppressBrowserContextMenu:false,monitorResize:true,todayText:"Today",ddCreateEventText:"Create event for {0}",ddMoveEventText:"Move event to {0}",ddResizeEventText:"Update event to {0}",defaultEventTitleText:"(No title)",dateParamStart:"start",dateParamEnd:"end",dateParamFormat:"Y-m-d",editModal:false,enableEditDetails:true,weekendCls:"ext-cal-day-we",prevMonthCls:"ext-cal-day-prev",nextMonthCls:"ext-cal-day-next",todayCls:"ext-cal-day-today",hideMode:"offsets",weekCount:1,dayCount:1,eventSelector:".ext-cal-evt",eventOverClass:"ext-evt-over",eventElIdDelimiter:"-evt-",dayElIdDelimiter:"-day-",getEventBodyMarkup:Ext.emptyFn,getEventTemplate:Ext.emptyFn,initComponent:function(){this.setStartDate(this.startDate||new Date());Ext.ensible.cal.CalendarView.superclass.initComponent.call(this);if(this.readOnly===true){this.addClass("ext-cal-readonly")}this.addEvents({eventsrendered:true,eventclick:true,eventover:true,eventout:true,beforedatechange:true,datechange:true,rangeselect:true,beforeeventmove:true,eventmove:true,initdrag:true,dayover:true,dayout:true,editdetails:true,eventadd:true,eventupdate:true,eventcancel:true,beforeeventdelete:true,eventdelete:true})},afterRender:function(){Ext.ensible.cal.CalendarView.superclass.afterRender.call(this);this.renderTemplate();if(this.store){this.setStore(this.store,true);if(this.store.deferLoad){this.reloadStore(this.store.deferLoad);delete this.store.deferLoad}else{this.store.initialParams=this.getStoreParams()}}if(this.calendarStore){this.setCalendarStore(this.calendarStore,true)}this.el.on({mouseover:this.onMouseOver,mouseout:this.onMouseOut,click:this.onClick,resize:this.onResize,scope:this});if(this.enableContextMenus&&this.readOnly!==true){this.el.on("contextmenu",this.onContextMenu,this)}this.el.unselectable();if(this.enableDD&&this.readOnly!==true&&this.initDD){this.initDD()}this.on("eventsrendered",this.onEventsRendered,this);this.forceSize.defer(100,this)},getStoreDateParams:function(){var a={};a[this.dateParamStart]=this.viewStart.format(this.dateParamFormat);a[this.dateParamEnd]=this.viewEnd.format(this.dateParamFormat);return a},getStoreParams:function(){var a=this.getStoreDateParams();return a},reloadStore:function(a){Ext.ensible.log("reloadStore");a=Ext.isObject(a)?a:{};a.params=a.params||{};Ext.apply(a.params,this.getStoreParams());this.store.load(a)},onEventsRendered:function(){this.forceSize()},forceSize:function(){if(this.el&&this.el.child){var c=this.el.child(".ext-cal-hd-ct"),a=this.el.child(".ext-cal-body-ct"),b=this.el.parent();if(c&&a){a.setHeight(b.getHeight()-c.getHeight())}}},refresh:function(a){Ext.ensible.log("refresh (base), reload = "+a);if(a===true){this.reloadStore()}this.prepareData();this.renderTemplate();this.renderItems()},getWeekCount:function(){var a=Ext.ensible.Date.diffDays(this.viewStart,this.viewEnd);return Math.ceil(a/this.dayCount)},prepareData:function(){var h=this.startDate.getLastDateOfMonth(),c=0,g=0,f=this.viewStart.clone(),e=this.weekCount<1?6:this.weekCount;this.eventGrid=[[]];this.allDayGrid=[[]];this.evtMaxCount=[];var b=this.store.queryBy(function(i){return this.isEventVisible(i.data)},this);for(;c<e;c++){this.evtMaxCount[c]=0;if(this.weekCount==-1&&f>h){break}this.eventGrid[c]=this.eventGrid[c]||[];this.allDayGrid[c]=this.allDayGrid[c]||[];for(d=0;d<this.dayCount;d++){if(b.getCount()>0){var a=b.filterBy(function(k){var j=(f.getTime()==k.data[Ext.ensible.cal.EventMappings.StartDate.name].clearTime(true).getTime());var i=(c==0&&d==0&&(f>k.data[Ext.ensible.cal.EventMappings.StartDate.name]));return j||i},this);this.sortEventRecordsForDay(a);this.prepareEventGrid(a,c,d)}f=f.add(Date.DAY,1)}}this.currentWeekCount=c},prepareEventGrid:function(c,b,i){var g=this,h=0,f=g.viewStart.clone(),a=g.maxEventsPerDay||999,e;c.each(function(k){var l=Ext.ensible.cal.EventMappings;if(Ext.ensible.Date.diffDays(k.data[l.StartDate.name],k.data[l.EndDate.name])>0){var j=Ext.ensible.Date.diffDays(Ext.ensible.Date.max(g.viewStart,k.data[l.StartDate.name]),Ext.ensible.Date.min(g.viewEnd,k.data[l.EndDate.name]))+1;g.prepareEventGridSpans(k,g.eventGrid,b,i,j);g.prepareEventGridSpans(k,g.allDayGrid,b,i,j,true)}else{h=g.findEmptyRowIndex(b,i);g.eventGrid[b][i]=g.eventGrid[b][i]||[];g.eventGrid[b][i][h]=k;if(k.data[l.IsAllDay.name]){h=g.findEmptyRowIndex(b,i,true);g.allDayGrid[b][i]=g.allDayGrid[b][i]||[];g.allDayGrid[b][i][h]=k}}e=g[g.isHeaderView?"allDayGrid":"eventGrid"][b][i]||[];if(e.length&&g.evtMaxCount[b]<e.length){g.evtMaxCount[b]=Math.min(a+1,e.length)}return true},g)},prepareEventGridSpans:function(i,a,h,g,j,k){var f=h,b=g,l=this.findEmptyRowIndex(h,g,k),e=this.viewStart.clone();var c={event:i,isSpan:true,isSpanStart:true,spanLeft:false,spanRight:(g==6)};a[h][g]=a[h][g]||[];a[h][g][l]=c;while(--j){e=e.add(Date.DAY,1);if(e>this.viewEnd){break}if(++b>6){b=0;f++;l=this.findEmptyRowIndex(f,0)}a[f]=a[f]||[];a[f][b]=a[f][b]||[];a[f][b][l]={event:i,isSpan:true,isSpanStart:(b==0),spanLeft:(f>h)&&(b%7==0),spanRight:(b==6)&&(j>1)}}},findEmptyRowIndex:function(b,h,a){var f=a?this.allDayGrid:this.eventGrid,c=f[b]?f[b][h]||[]:[],e=0,g=c.length;for(;e<g;e++){if(c[e]==null){return e}}return g},renderTemplate:function(){if(this.tpl){this.tpl.overwrite(this.el,this.getTemplateParams());this.lastRenderStart=this.viewStart.clone();this.lastRenderEnd=this.viewEnd.clone()}},getTemplateParams:function(){return{viewStart:this.viewStart,viewEnd:this.viewEnd,startDate:this.startDate,dayCount:this.dayCount,weekCount:this.weekCount,weekendCls:this.weekendCls,prevMonthCls:this.prevMonthCls,nextMonthCls:this.nextMonthCls,todayCls:this.todayCls}},disableStoreEvents:function(){this.monitorStoreEvents=false;return this},enableStoreEvents:function(a){this.monitorStoreEvents=true;if(a===true){this.refresh()}return this},onResize:function(){this.refresh(false)},onInitDrag:function(){this.fireEvent("initdrag",this)},onEventDrop:function(b,a){this.moveEvent(b,a)},onCalendarEndDrag:function(e,a,c){this.dragPending=true;var b={},c=this.onCalendarEndDragComplete.createDelegate(this,[c]);b[Ext.ensible.cal.EventMappings.StartDate.name]=e;b[Ext.ensible.cal.EventMappings.EndDate.name]=a;if(this.fireEvent("rangeselect",this,b,c)!==false){this.showEventEditor(b,null);this.editWin.on("hide",c,this,{single:true})}else{this.onCalendarEndDragComplete(c)}},onCalendarEndDragComplete:function(a){a();this.dragPending=false},onUpdate:function(b,c,a){if(this.hidden===true||this.monitorStoreEvents===false){return}if(a==Ext.data.Record.COMMIT){Ext.ensible.log("onUpdate");this.dismissEventEditor();var e=c.data[Ext.ensible.cal.EventMappings.RRule.name];this.refresh(e!==undefined&&e!=="");if(this.enableFx&&this.enableUpdateFx){this.doUpdateFx(this.getEventEls(c.data[Ext.ensible.cal.EventMappings.EventId.name]),{scope:this})}}},doUpdateFx:function(a,b){this.highlightEvent(a,null,b)},onAdd:function(c,b,a){var e=Ext.isArray(b)?b[0]:b;if(this.hidden===true||this.monitorStoreEvents===false||e.phantom){return}if(e._deleting){delete e._deleting;return}Ext.ensible.log("onAdd");var f=e.data[Ext.ensible.cal.EventMappings.RRule.name];this.dismissEventEditor();this.tempEventId=e.id;this.refresh(f!==undefined&&f!=="");if(this.enableFx&&this.enableAddFx){this.doAddFx(this.getEventEls(e.data[Ext.ensible.cal.EventMappings.EventId.name]),{scope:this})}},doAddFx:function(a,b){a.fadeIn(Ext.apply(b,{duration:2}))},onRemove:function(b,c){if(this.hidden===true||this.monitorStoreEvents===false){return}Ext.ensible.log("onRemove");this.dismissEventEditor();var e=c.data[Ext.ensible.cal.EventMappings.RRule.name],a=e!==undefined&&e!=="";if(this.enableFx&&this.enableRemoveFx){this.doRemoveFx(this.getEventEls(c.data[Ext.ensible.cal.EventMappings.EventId.name]),{remove:true,scope:this,callback:this.refresh.createDelegate(this,[a])})}else{this.getEventEls(c.data[Ext.ensible.cal.EventMappings.EventId.name]).remove();this.refresh(a)}},doRemoveFx:function(a,b){if(a.getCount()==0&&Ext.isFunction(b.callback)){b.callback.call(b.scope||this)}else{a.fadeOut(b)}},highlightEvent:function(b,a,e){if(this.enableFx){var f;!(Ext.isIE||Ext.isOpera)?b.highlight(a,e):b.each(function(c){c.highlight(a,Ext.applyIf({attr:"color"},e));if(f=c.child(".ext-cal-evm")){f.highlight(a,e)}},this)}},getEventIdFromEl:function(c){c=Ext.get(c);var e,f="",a,b=c.dom.className.split(" ");Ext.each(b,function(g){e=g.split(this.eventElIdDelimiter);if(e.length>1){f=e[1];return false}},this);return f},getEventId:function(a){if(a===undefined&&this.tempEventId){a=this.tempEventId}return a},getEventSelectorCls:function(b,a){var c=a?".":"";return c+this.id+this.eventElIdDelimiter+this.getEventId(b)},getEventEls:function(b){var a=this.el.select(this.getEventSelectorCls(this.getEventId(b),true),false);return new Ext.CompositeElement(a)},isToday:function(){var a=new Date().clearTime().getTime();return this.viewStart.getTime()<=a&&this.viewEnd.getTime()>=a},onDataChanged:function(a){Ext.ensible.log("onDataChanged");this.refresh(false)},isEventVisible:function(i){var f=Ext.ensible.cal.EventMappings,e=i.data?i.data:i,h=e[f.CalendarId.name],b=this.calendarStore?this.calendarStore.getById(h):null;if(b&&b.data[Ext.ensible.cal.CalendarMappings.IsHidden.name]===true){return false}var a=this.viewStart.getTime(),c=this.viewEnd.getTime(),j=e[f.StartDate.name].getTime(),g=e[f.EndDate.name].getTime();return Ext.ensible.Date.rangesOverlap(a,c,j,g)},isOverlapping:function(l,k){var j=l.data?l.data:l,i=k.data?k.data:k,f=Ext.ensible.cal.EventMappings,c=j[f.StartDate.name].getTime(),g=j[f.EndDate.name].add(Date.SECOND,-1).getTime(),b=i[f.StartDate.name].getTime(),e=i[f.EndDate.name].add(Date.SECOND,-1).getTime(),h=Ext.ensible.Date.diff(j[f.StartDate.name],i[f.StartDate.name],"m");if(g<c){g=c}if(e<b){e=b}var n=Ext.ensible.Date.rangesOverlap(c,g,b,e),m=this.minEventDisplayMinutes||0,a=m>0&&(h>-m&&h<m);return(n||a)},getDayEl:function(a){return Ext.get(this.getDayId(a))},getDayId:function(a){if(Ext.isDate(a)){a=a.format("Ymd")}return this.id+this.dayElIdDelimiter+a},getStartDate:function(){return this.startDate},setStartDate:function(b,a){Ext.ensible.log("setStartDate (base) "+b.format("Y-m-d"));if(this.fireEvent("beforedatechange",this,this.startDate,b,this.viewStart,this.viewEnd)!==false){this.startDate=b.clearTime();this.setViewBounds(b);if(this.rendered){this.refresh(a)}this.fireEvent("datechange",this,this.startDate,this.viewStart,this.viewEnd)}},setViewBounds:function(a){var e=a||this.startDate,c=e.getDay()-this.startDay;if(c<0){c+=7}switch(this.weekCount){case 0:case 1:this.viewStart=this.dayCount<7&&!this.startDayIsStatic?e:e.add(Date.DAY,-c).clearTime(true);this.viewEnd=this.viewStart.add(Date.DAY,this.dayCount||7).add(Date.SECOND,-1);return;case -1:e=e.getFirstDateOfMonth();c=e.getDay()-this.startDay;if(c<0){c+=7}this.viewStart=e.add(Date.DAY,-c).clearTime(true);var b=e.add(Date.MONTH,1).add(Date.SECOND,-1);c=this.startDay;if(c>b.getDay()){c-=7}this.viewEnd=b.add(Date.DAY,6-b.getDay()+c);return;default:this.viewStart=e.add(Date.DAY,-c).clearTime(true);this.viewEnd=this.viewStart.add(Date.DAY,this.weekCount*7).add(Date.SECOND,-1)}},getViewBounds:function(){return{start:this.viewStart,end:this.viewEnd}},sortEventRecordsForDay:function(a){if(a.length<2){return}a.sort("ASC",function(g,f){var e=g.data,c=f.data,i=Ext.ensible.cal.EventMappings;if(e[i.IsAllDay.name]){return -1}else{if(c[i.IsAllDay.name]){return 1}}if(this.spansHavePriority){var h=Ext.ensible.Date.diffDays;if(h(e[i.StartDate.name],e[i.EndDate.name])>0){if(h(c[i.StartDate.name],c[i.EndDate.name])>0){if(e[i.StartDate.name].getTime()==c[i.StartDate.name].getTime()){return c[i.EndDate.name].getTime()-e[i.EndDate.name].getTime()}return e[i.StartDate.name].getTime()-c[i.StartDate.name].getTime()}return -1}else{if(h(c[i.StartDate.name],c[i.EndDate.name])>0){return 1}}return e[i.StartDate.name].getTime()-c[i.StartDate.name].getTime()}else{return e[i.StartDate.name].getTime()-c[i.StartDate.name].getTime()}}.createDelegate(this))},moveTo:function(b,a){if(Ext.isDate(b)){this.setStartDate(b,a);return this.startDate}return b},moveNext:function(a){return this.moveTo(this.viewEnd.add(Date.DAY,1),a)},movePrev:function(a){var b=Ext.ensible.Date.diffDays(this.viewStart,this.viewEnd)+1;return this.moveDays(-b,a)},moveMonths:function(b,a){return this.moveTo(this.startDate.add(Date.MONTH,b),a)},moveWeeks:function(b,a){return this.moveTo(this.startDate.add(Date.DAY,b*7),a)},moveDays:function(b,a){return this.moveTo(this.startDate.add(Date.DAY,b),a)},moveToday:function(a){return this.moveTo(new Date(),a)},setStore:function(a,b){var c=this.store;if(!b&&c){c.un("datachanged",this.onDataChanged,this);c.un("clear",this.refresh,this);c.un("write",this.onWrite,this);c.un("exception",this.onException,this)}if(a){a.on("datachanged",this.onDataChanged,this);a.on("clear",this.refresh,this);a.on("write",this.onWrite,this);a.on("exception",this.onException,this)}this.store=a},onException:function(c,e,f,g,b,a){if(a.reject){a.reject()}},setCalendarStore:function(a,b){if(!b&&this.calendarStore){this.calendarStore.un("datachanged",this.refresh,this);this.calendarStore.un("add",this.refresh,this);this.calendarStore.un("remove",this.refresh,this);this.calendarStore.un("update",this.refresh,this)}if(a){a.on("datachanged",this.refresh,this);a.on("add",this.refresh,this);a.on("remove",this.refresh,this);a.on("update",this.refresh,this)}this.calendarStore=a},getEventRecord:function(b){var a=this.store.find(Ext.ensible.cal.EventMappings.EventId.name,b,0,false,true);return this.store.getAt(a)},getEventRecordFromEl:function(a){return this.getEventRecord(this.getEventIdFromEl(a))},getEventEditor:function(){this.editWin=this.editWin||Ext.WindowMgr.get("ext-cal-editwin");if(!this.editWin){this.editWin=new Ext.ensible.cal.EventEditWindow({id:"ext-cal-editwin",calendarStore:this.calendarStore,modal:this.editModal,enableEditDetails:this.enableEditDetails,listeners:{eventadd:{fn:function(b,c,a){b.currentView.onEventAdd(null,c)},scope:this},eventupdate:{fn:function(b,c,a){b.currentView.onEventUpdate(null,c)},scope:this},eventdelete:{fn:function(b,c,a){b.currentView.onEventDelete(null,c)},scope:this},editdetails:{fn:function(c,e,b,a){c.hide(b);c.currentView.fireEvent("editdetails",c.currentView,e,b)},scope:this},eventcancel:{fn:function(b,c,a){this.dismissEventEditor(a);b.currentView.onEventCancel()},scope:this}}})}this.editWin.currentView=this;return this.editWin},showEventEditor:function(b,a){this.getEventEditor().show(b,a,this);return this},dismissEventEditor:function(b,c){if(this.newRecord&&this.newRecord.phantom){this.store.remove(this.newRecord)}delete this.newRecord;var a=Ext.WindowMgr.get("ext-cal-editwin");if(a){a[b?b:"hide"](c)}return this},save:function(){if(!this.store.autoSave){this.store.save()}},onWrite:function(a,c,b,f,e){switch(c){case"create":this.onAdd(a,e);break;case"update":this.onUpdate(a,e,Ext.data.Record.COMMIT);break;case"destroy":this.onRemove(a,e);break}},onEventAdd:function(a,b){this.newRecord=b;if(!b.store){this.store.add(b);this.save()}this.fireEvent("eventadd",this,b)},onEventUpdate:function(a,b){this.save();this.fireEvent("eventupdate",this,b)},onEventDelete:function(a,b){if(b.store){this.store.remove(b)}this.save();this.fireEvent("eventdelete",this,b)},onEventCancel:function(a,b){this.fireEvent("eventcancel",this,b)},onDayClick:function(c,b,a){if(this.readOnly===true){return}if(this.fireEvent("dayclick",this,c,b,a)!==false){var f=Ext.ensible.cal.EventMappings,e={};e[f.StartDate.name]=c;e[f.IsAllDay.name]=b;this.showEventEditor(e,a)}},showEventMenu:function(a,b){if(!this.eventMenu){this.eventMenu=new Ext.ensible.cal.EventContextMenu({listeners:{editdetails:this.onEditDetails.createDelegate(this),eventdelete:this.onDeleteEvent.createDelegate(this),eventmove:this.onMoveEvent.createDelegate(this)}})}this.eventMenu.showForEvent(this.getEventRecordFromEl(a),a,b);this.menuActive=true},onEditDetails:function(c,b,a){this.fireEvent("editdetails",this,b,a);this.menuActive=false},onMoveEvent:function(c,b,a){this.moveEvent(b,a);this.menuActive=false},moveEvent:function(c,a){if(Ext.ensible.Date.compare(c.data[Ext.ensible.cal.EventMappings.StartDate.name],a)===0){return}if(this.fireEvent("beforeeventmove",this,c,a)!==false){var b=a.getTime()-c.data[Ext.ensible.cal.EventMappings.StartDate.name].getTime();c.beginEdit();c.set(Ext.ensible.cal.EventMappings.StartDate.name,a);c.set(Ext.ensible.cal.EventMappings.EndDate.name,c.data[Ext.ensible.cal.EventMappings.EndDate.name].add(Date.MILLI,b));c.endEdit();this.save();this.fireEvent("eventmove",this,c)}},onDeleteEvent:function(c,b,a){b._deleting=true;this.deleteEvent(b,a);this.menuActive=false},deleteEvent:function(b,a){if(this.fireEvent("beforeeventdelete",this,b,a)!==false){this.store.remove(b);this.save();this.fireEvent("eventdelete",this,b,a)}},onContextMenu:function(f,b){var c,a=false;if(c=f.getTarget(this.eventSelector,5,true)){this.dismissEventEditor().showEventMenu(c,f.getXY());a=true}if(a||this.suppressBrowserContextMenu===true){f.preventDefault()}},onClick:function(c,a){if(this.readOnly===true){return true}if(this.dropZone){this.dropZone.clearShims()}if(this.menuActive===true){this.menuActive=false;return true}var b=c.getTarget(this.eventSelector,5);if(b){var g=this.getEventIdFromEl(b),f=this.getEventRecord(g);if(this.fireEvent("eventclick",this,f,b)!==false){this.showEventEditor(f,b)}return true}},onMouseOver:function(b,a){if(this.trackMouseOver!==false&&(this.dragZone==undefined||!this.dragZone.dragging)){if(!this.handleEventMouseEvent(b,a,"over")){this.handleDayMouseEvent(b,a,"over")}}},onMouseOut:function(b,a){if(this.trackMouseOver!==false&&(this.dragZone==undefined||!this.dragZone.dragging)){if(!this.handleEventMouseEvent(b,a,"out")){this.handleDayMouseEvent(b,a,"out")}}},handleEventMouseEvent:function(h,c,g){var f;if(f=h.getTarget(this.eventSelector,5,true)){var a=Ext.get(h.getRelatedTarget());if(f==a||f.contains(a)){return true}var i=this.getEventIdFromEl(f);if(this.eventOverClass!=""){var b=this.getEventEls(i);b[g=="over"?"addClass":"removeClass"](this.eventOverClass)}this.fireEvent("event"+g,this,this.getEventRecord(i),f);return true}return false},getDateFromId:function(c,b){var a=c.split(b);return a[a.length-1]},handleDayMouseEvent:function(j,f,h){if(f=j.getTarget("td",3)){if(f.id&&f.id.indexOf(this.dayElIdDelimiter)>-1){var i=this.getDateFromId(f.id,this.dayElIdDelimiter),a=Ext.get(j.getRelatedTarget()),c,b;if(a){c=a.is("td")?a:a.up("td",3);b=c&&c.id?this.getDateFromId(c.id,this.dayElIdDelimiter):""}if(!a||i!=b){var g=this.getDayEl(i);if(g&&this.dayOverClass!=""){g[h=="over"?"addClass":"removeClass"](this.dayOverClass)}this.fireEvent("day"+h,this,Date.parseDate(i,"Ymd"),g)}}}},renderItems:function(){throw"This method must be implemented by a subclass"},destroy:function(){Ext.ensible.cal.CalendarView.superclass.destroy.call(this);if(this.el){this.el.un("contextmenu",this.onContextMenu,this)}Ext.destroy(this.editWin,this.eventMenu,this.dragZone,this.dropZone)}});